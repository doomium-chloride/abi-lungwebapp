
<section id="view-nifti" class="clickable">
    <div id="select" style="font-family:sans-serif">
        <h3>NIFTI-Reader-JS &mdash; JavaScript NIFTI Reader</h3>
        <h4><a href="https://github.com/rii-mango/NIFTI-Reader-JS">https://github.com/rii-mango/NIFTI-Reader-JS</a></h4>
        <p>Select a file: <input type="file" id="file" name="files" /></p>
        <p>Select a mask: <input type="file" id="mask" name="files" /></p>
        <hr />
        <button id="applymask">Apply mask</button>
    </div>
    
    <div id="results">
        <canvas id="myCanvas" width="100" height="100"></canvas><br />
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
    </div>
</section>

<script type="text/javascript">
    let viewMask = false;
    let testMask = null;
    let testFile = null;
    let niftiIMG = null;
    function drawCanvas(canvas, slice, img) {
        // get nifti dimensions
        var cols = img.length;
        var rows = img[0].length;

        // set canvas dimensions to nifti slice dimensions
        canvas.width = cols;
        canvas.height = rows;

        // make canvas image data
        var ctx = canvas.getContext("2d");
        var canvasImageData = ctx.createImageData(canvas.width, canvas.height);

        // offset to specified slice
        var sliceSize = cols * rows;
        var sliceOffset = sliceSize * slice;
        let display = [];
        let lowest = 100000;
        let highest = -100000;
        
        let output = new Array(rows);
        // draw pixels
        for (var row = 0; row < rows; row++) {
            var rowOffset = row * cols;
            let colArray = new Array(cols);
            for (var col = 0; col < cols; col++) {
                var offset = sliceOffset + rowOffset + col;
                var value = img[row][col];

                /* 
                Assumes data is 8-bit, otherwise you would need to first convert 
                to 0-255 range based on datatype range, data range (iterate through
                data to find), or display range (cal_min/max).
                
                Other things to take into consideration:
                    - data scale: scl_slope and scl_inter, apply to raw value before 
                    applying display range
                    - orientation: displays in raw orientation, see nifti orientation 
                    info for how to orient data
                    - assumes voxel shape (pixDims) is isometric, if not, you'll need 
                    to apply transform to the canvas
                    - byte order: see littleEndian flag
                */
                colArray[col] = value;
                if(viewMask && false){
                    value = to255(value, 0, 1);
                } else{
                    value = to255(value, -32768, 32767)
                }
                
                display.push(value & 0xFF)
                if(value > highest)
                    highest = value;
                if(value < lowest)
                    lowest = value;
                
                canvasImageData.data[(rowOffset + col) * 4] = value & 0xFF;
                canvasImageData.data[(rowOffset + col) * 4 + 1] = value & 0xFF;
                canvasImageData.data[(rowOffset + col) * 4 + 2] = value & 0xFF;
                canvasImageData.data[(rowOffset + col) * 4 + 3] = 0xFF;
            }
            output[row] = colArray;
        }
        console.log(display)
        console.log("lowest= " + lowest);
        console.log("highest= " + highest);
        console.log(output);
        ctx.putImageData(canvasImageData, 0, 0);
    }
    function setUpSlider(img){
        var slices = saveNifti.main.qtd.length;
        slider.max = slices - 1;
        slider.value = Math.round(slices / 2);
        slider.oninput = function() {
            drawCanvas(canvas, slider.value, img);
        };
    }
    function viewMasked() {
        setUpSlider();

    }
    let applymaskbutton = document.getElementById('applymask');
    applymaskbutton.addEventListener('click', () => {
        if(userFiles.main == null || userFiles.mask == null){
            alert("Please select both files");
            return;
        }
        loadUserFile('main');
        loadUserFile('mask');
        let mainArray = saveNifti.main.qtd
        let maskArray = saveNifti.mask.qtd
        niftiIMG = mask3d(mainArray, maskArray);
        setUpSlider(img);
    })
    document.getElementById('file').addEventListener('change', (e) => handleFileSelect(e, 'main'), false);
    document.getElementById('mask').addEventListener('change', (e) => handleFileSelect(e, 'mask'), false);
</script>