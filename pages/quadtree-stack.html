<section id="page-qtd-stack">
    <img src="images/back.svg" id="back-button" onclick="window.history.back()" class="clickable back-button"/>
    <div class="center-head">
        <h2 style="display: inline;">Lung stack</h2>
        <label class="tooltip clickable">&#x1F6C8<input type="checkbox"><span>
            <p>
                QtD values pooled from an IPF cohort are shown in red. 
            </p>
            <p>
                QtD values pooled from a healthy older adult cohort are shown in green. 
            </p>
            <p>
                Select the window size and lung height at which you want QtD value reported.
            </p>
        </span></label>
    </div>
    <article class="left center-text" style="width: 10vw;">  
        <h5>Height from bottom</h5>
        <h4><span id="vertical-value"></span>%</h4>
        <input id="vertical-slider" class="clickable vertical-slider" type="range" orient="vertical" min="20" max="80" value="50" />
        
    </article>
	<article class="center-stack center-text">

        <p class="center-text">
            QtD = <span id="qtd-value"></span>
        </p>

        <div id="graph" class="sliding-graph">
            <div id="graph-slider" class="line"></div>
            <canvas id="stack-chart" aria-label="QtD Graph" role="img"></canvas>
            
        </div>
        
        <div id="select" class="clickable" style="font-family:sans-serif">
            <p>Select a file: <input type="file" id="file" name="files" /></p>
            <p>Select a mask: <input type="file" id="mask" name="files" /></p>
            <hr />
            <button id="applymask">apply mask</button>
        </div>

	</article>
	<article class="right middle" style="width: 40vw;">

        <label for="range-slider" class="slider-description">
            Selection range
        </label>
        <span class="side-pic">
            <img id="stack-block" class="side-pic crop-side-pic" src="images/stack/block300.jpg">
        </span>
        <span class="side-pic">
            <img id="stack-image" class="side-pic" src="images/stack/image300.jpg">
        </span>

        <div class="colour-bar-stack">
            <img src="images/colour-bar.png">
        </div>

        <div class="center-text">
            <img id="lung-pic" src="images/base-lung.png" class="lung-pic">
            
            <div class="lung-slider-div">
                <div id="h-line" class="horizontal-line"></div>
                <input id='lung-slider' class="clickable lung-slider" type="range" orient="vertical" min="20" max="80" value="50" />
            </div>
            
        </div>
        
        <input id="range-slider" class="clickable range-slider" type="range" orient="vertical" min="0" max="60" value="0" />
        
        
    </article>
    <img src="images/abi-hc-rgb-new.png" class="overlay">
    <img src="images/MedTech CoRE Logo.png" class="medtechlogo">
</section>

<script>
initStack();
function showDims(array){
    let len1 = array.length;
    let len2 = array[0].length;
    let len3 = array[0][0].length;
    console.log(`dims=${len1}-${len2}-${len3}`);
}
document.getElementById('file').addEventListener('change', (e) => {
    lockMain = true;
    handleFileSelect(e, 'main');
    loadUserFile('main');
}, false);
document.getElementById('mask').addEventListener('change', (e) => {
    lockMask = true;
    handleFileSelect(e, 'mask');
    loadUserFile('mask');
}, false);
//let showarray = document.getElementById('showarray');

document.getElementById('applymask').addEventListener('click', () => {
    if(userFiles.main == null || userFiles.mask == null){
        alert("Please select both files");
        return;
    }
    if(lockMain || lockMask){
        alert('files not ready');
        return;
    }
    let mainArray = saveNifti.main.qtd
    let maskArray = saveNifti.mask.qtd
    showDims(mainArray);
    showDims(maskArray);
    let result = mask3d(mainArray, maskArray);
    qtdImg = result;
    result = computeQtD(result);
    result = processNifti(result);
    console.log(result);
    let labels = Object.keys(result);
    let lower = getNearestIndex(labels, 20);
    let upper = getNearestIndex(labels, 80) + 1;
    let arr = [];
    for(const x in result){
        arr.push(result[x]);
    }
    stackChart.data.datasets[0].data = arr.slice(lower, upper);
    console.log(arr);
    console.log(arr.slice(lower, upper));
    stackChart.update();
    return arr;
});
</script>
